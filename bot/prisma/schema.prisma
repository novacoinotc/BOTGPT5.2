generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Trade {
  id              String   @id @default(uuid())
  symbol          String
  side            String   // LONG or SHORT
  entryPrice      Float
  exitPrice       Float?
  quantity        Float
  leverage        Int      @default(1)
  pnl             Float?   // percentage
  pnlPercent      Float?   // same as pnl, for compatibility
  pnlUsd          Float?
  entryTime       DateTime @default(now())
  exitTime        DateTime?
  status          String   @default("OPEN") // OPEN or CLOSED
  exitReason      String?  // tp, sl, manual, timeout, signal
  stopLoss        Float?
  takeProfit      Float?
  gptConfidence   Int?     // Changed to Int to match Neon
  gptReasoning    String?
  entryConditions Json?    // JSONB field for all entry conditions

  // Individual entry condition fields for querying
  rsi             Float?
  macdHistogram   Float?
  orderBookImbalance Float?
  fundingRate     Float?
  regime          String?
  fearGreedValue  Int?
  newsScore       Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([symbol])
  @@index([entryTime])
  @@index([exitReason])
  @@index([status])
}

model Pattern {
  id              String   @id @default(uuid())
  symbol          String
  patternType     String
  regime          String

  // Indicators at detection
  rsi             Float
  macdHistogram   Float
  orderBookImbalance Float
  fundingRate     Float

  decision        String   // BUY or SELL
  confidence      Float

  outcome         String?  // success or failure
  resultPnl       Float?

  timestamp       DateTime
  createdAt       DateTime @default(now())

  @@index([symbol])
  @@index([patternType])
  @@index([outcome])
}

model Learning {
  id              String   @id @default(uuid())
  lesson          String
  type            String   // success or failure
  context         Json?
  useCount        Int      @default(1)

  timestamp       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([useCount])
}

model BotState {
  id              String   @id @default("main")
  isRunning       Boolean  @default(false)
  balance         Float    @default(0)
  todayPnl        Float    @default(0)
  todayTrades     Int      @default(0)
  lastResetDate   DateTime @default(now())

  symbols         String[] @default(["BTCUSDT", "ETHUSDT"])

  updatedAt       DateTime @updatedAt
}

model DailyStats {
  id              String   @id @default(uuid())
  date            DateTime @unique
  totalTrades     Int
  winningTrades   Int
  losingTrades    Int
  totalPnl        Float
  totalPnlUsd     Float
  avgPnl          Float
  maxDrawdown     Float
  bestTrade       Float
  worstTrade      Float

  createdAt       DateTime @default(now())

  @@index([date])
}

// Q-Learning state values for adaptive trading
model QState {
  id              String   @id @default(uuid())
  stateKey        String   @unique

  // Q-values for each action type
  skipValue       Float    @default(0)
  openConservative Float   @default(0)
  openNormal      Float    @default(0)
  openAggressive  Float    @default(0)
  futuresLow      Float    @default(0)
  futuresMedium   Float    @default(0)
  futuresHigh     Float    @default(0)

  // Statistics
  visits          Int      @default(0)
  lastReward      Float    @default(0)
  avgReward       Float    @default(0)
  winCount        Int      @default(0)
  lossCount       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([stateKey])
  @@index([avgReward])
}

// Market snapshots for analysis and learning
model MarketSnapshot {
  id              String   @id @default(uuid())
  symbol          String
  signal          String   // BUY, SELL, NEUTRAL
  rsi             Float
  rsiZone         String   // LOW, NEUTRAL, HIGH
  macdHistogram   Float
  regime          String   // trending_up, trending_down, ranging, volatile
  regimeStrength  Float
  orderbook       String   // BUY_PRESSURE, SELL_PRESSURE, NEUTRAL
  volatility      String   // LOW, MEDIUM, HIGH, VERY_HIGH
  volatilityPct   Float
  fearGreedIndex  Int
  fearGreedZone   String   // EXTREME_FEAR, FEAR, NEUTRAL, GREED, EXTREME_GREED
  stateKey        String
  actionTaken     String   // SKIP, OPEN_CONSERVATIVE, etc.
  actionResult    String?  // WIN, LOSS, SKIP
  reward          Float?

  timestamp       DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([symbol])
  @@index([stateKey])
  @@index([timestamp])
}

// Dynamic parameters for optimization
model DynamicParams {
  id                    String   @id @default("main")
  minConfidence         Float    @default(55)
  basePositionPct       Float    @default(2)
  conservativeLev       Int      @default(2)
  balancedLev           Int      @default(3)
  aggressiveLev         Int      @default(5)
  baseTpPct             Float    @default(0.5)
  baseSlPct             Float    @default(0.3)
  maxDailyLossPct       Float    @default(5)
  consecutiveLossLimit  Int      @default(3)

  updatedAt             DateTime @updatedAt
}

// Parameter change history for auditing
model ParamChange {
  id              String   @id @default(uuid())
  param           String
  oldValue        Float
  newValue        Float
  reason          String
  strategy        String

  timestamp       DateTime @default(now())

  @@index([param])
  @@index([timestamp])
}

// Performance metrics history
model PerformanceMetrics {
  id              String   @id @default(uuid())
  winRate         Float
  roi             Float
  maxDrawdown     Float
  totalTrades     Int
  avgPnl          Float
  profitFactor    Float

  timestamp       DateTime @default(now())

  @@index([timestamp])
}
