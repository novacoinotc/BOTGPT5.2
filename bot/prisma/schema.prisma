generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Trade {
  id              String   @id @default(uuid())
  symbol          String
  side            String   // LONG or SHORT
  entryPrice      Float
  exitPrice       Float?
  quantity        Float
  leverage        Int      @default(1)
  pnl             Float?   // percentage
  pnlPercent      Float?   // same as pnl, for compatibility
  pnlUsd          Float?
  entryTime       DateTime @default(now())
  exitTime        DateTime?
  status          String   @default("OPEN") // OPEN or CLOSED
  exitReason      String?  // tp, sl, manual, timeout, signal
  stopLoss        Float?
  takeProfit      Float?
  gptConfidence   Int?     // Changed to Int to match Neon
  gptReasoning    String?
  entryConditions Json?    // JSONB field for all entry conditions

  // Individual entry condition fields for querying
  rsi             Float?
  macdHistogram   Float?
  orderBookImbalance Float?
  fundingRate     Float?
  regime          String?
  fearGreedValue  Int?
  newsScore       Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([symbol])
  @@index([entryTime])
  @@index([exitReason])
  @@index([status])
}

model Pattern {
  id              String   @id @default(uuid())
  symbol          String
  patternType     String
  regime          String

  // Indicators at detection
  rsi             Float
  macdHistogram   Float
  orderBookImbalance Float
  fundingRate     Float

  decision        String   // BUY or SELL
  confidence      Float

  outcome         String?  // success or failure
  resultPnl       Float?

  timestamp       DateTime
  createdAt       DateTime @default(now())

  @@index([symbol])
  @@index([patternType])
  @@index([outcome])
}

model Learning {
  id              String   @id @default(uuid())
  lesson          String
  type            String   // success or failure
  context         Json?
  useCount        Int      @default(1)

  timestamp       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([type])
  @@index([useCount])
}

model BotState {
  id              String   @id @default("main")
  isRunning       Boolean  @default(false)
  balance         Float    @default(0)
  todayPnl        Float    @default(0)
  todayTrades     Int      @default(0)
  lastResetDate   DateTime @default(now())

  symbols         String[] @default(["BTCUSDT", "ETHUSDT"])

  updatedAt       DateTime @updatedAt
}

model DailyStats {
  id              String   @id @default(uuid())
  date            DateTime @unique
  totalTrades     Int
  winningTrades   Int
  losingTrades    Int
  totalPnl        Float
  totalPnlUsd     Float
  avgPnl          Float
  maxDrawdown     Float
  bestTrade       Float
  worstTrade      Float

  createdAt       DateTime @default(now())

  @@index([date])
}

// Q-Learning state values for adaptive trading
model QState {
  id              String   @id @default(uuid())
  stateKey        String   @unique

  // Q-values for each action type
  skipValue       Float    @default(0)
  openConservative Float   @default(0)
  openNormal      Float    @default(0)
  openAggressive  Float    @default(0)
  futuresLow      Float    @default(0)
  futuresMedium   Float    @default(0)
  futuresHigh     Float    @default(0)

  // Statistics
  visits          Int      @default(0)
  lastReward      Float    @default(0)
  avgReward       Float    @default(0)
  winCount        Int      @default(0)
  lossCount       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([stateKey])
  @@index([avgReward])
}

// Market snapshots for analysis and learning
model MarketSnapshot {
  id              String   @id @default(uuid())
  symbol          String
  signal          String   // BUY, SELL, NEUTRAL
  rsi             Float
  rsiZone         String   // LOW, NEUTRAL, HIGH
  macdHistogram   Float
  regime          String   // trending_up, trending_down, ranging, volatile
  regimeStrength  String   // WEAK, MODERATE, STRONG
  orderbook       String   // BUY_PRESSURE, SELL_PRESSURE, NEUTRAL
  volatility      String   // LOW, MEDIUM, HIGH, VERY_HIGH
  volatilityPct   Float
  fearGreedIndex  Int
  fearGreedZone   String   // EXTREME_FEAR, FEAR, NEUTRAL, GREED, EXTREME_GREED
  stateKey        String
  actionTaken     String   // SKIP, OPEN_CONSERVATIVE, etc.
  actionResult    String?  // WIN, LOSS, SKIP
  reward          Float?

  timestamp       DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([symbol])
  @@index([stateKey])
  @@index([timestamp])
}

// Dynamic parameters for optimization (from 87.95% WR IA)
model DynamicParams {
  id                    String   @id @default("main")

  // Trading Thresholds
  minConfidence         Float    @default(55)
  profitThreshold       Float    @default(1.67)

  // RSI Configuration
  rsiOversold           Float    @default(26)
  rsiOverbought         Float    @default(74)
  rsiPeriod             Int      @default(10)

  // Position Sizing
  basePositionPct       Float    @default(7.43)
  maxPositionPct        Float    @default(11.74)
  maxRiskPerTrade       Float    @default(2.89)
  maxPositions          Int      @default(5)

  // Leverage Settings
  conservativeLev       Int      @default(5)
  balancedLev           Int      @default(6)
  aggressiveLev         Int      @default(14)

  // Futures Conditions
  minConfFutures        Float    @default(75.68)
  minWinrateFutures     Float    @default(46.13)
  maxDrawdownFutures    Float    @default(6.11)
  volThresholdFutures   Float    @default(0.025)

  // Fear & Greed
  fgExtremeThreshold    Float    @default(24)
  fgOpportunityBoost    Float    @default(1.85)

  // Take Profit / Stop Loss
  tpBasePct             Float    @default(0.31)
  tpDynamicMultiplier   Float    @default(1.92)
  slBasePct             Float    @default(0.30)
  baseTpPct             Float    @default(0.5)
  baseSlPct             Float    @default(0.3)

  // Risk Management
  maxDailyLossPct       Float    @default(5)
  consecutiveLossLimit  Int      @default(3)

  // Performance tracking
  currentWinRate        Float    @default(0)
  currentROI            Float    @default(0)
  totalTrials           Int      @default(0)
  lastOptimization      DateTime?

  updatedAt             DateTime @updatedAt
}

// Parameter change history for auditing
model ParamChange {
  id                  String   @id @default(uuid())
  changeNumber        Int
  triggerReason       String
  strategy            String
  winRateBefore       Float
  roiBefore           Float
  drawdownBefore      Float
  paramsChanged       String[] // Array of parameter names changed
  reasoning           String
  totalTradesAtChange Int

  // Legacy fields (kept for compatibility)
  param               String?
  oldValue            Float?
  newValue            Float?
  reason              String?

  timestamp           DateTime @default(now())

  @@index([changeNumber])
  @@index([strategy])
  @@index([timestamp])
}

// Performance metrics history
model PerformanceMetrics {
  id              String   @id @default(uuid())
  winRate         Float
  roi             Float
  maxDrawdown     Float
  totalTrades     Int
  avgPnl          Float
  profitFactor    Float

  timestamp       DateTime @default(now())

  @@index([timestamp])
}
